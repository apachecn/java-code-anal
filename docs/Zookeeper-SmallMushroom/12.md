# Zookeeper æºç é˜…è¯»(åäºŒ) Seesion(1)

> åŸæ–‡ï¼š[https://www.cnblogs.com/gongcomeon/p/10198222.html](https://www.cnblogs.com/gongcomeon/p/10198222.html)

### å‰è¨€

å‰é¢ä¸‰ç¯‡ä¸»è¦ä» client çš„è§’åº¦è¯´äº†ä¸‹ client å’Œ server å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œè¿™ä¸€ç¯‡å’Œåé¢ä¸€ç¯‡å¼€å§‹çœ‹ä¸‹ Zookeeper ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šSessionï¼Œsession æ˜¯ zookeeper client å’Œ server å»ºç«‹å’Œç»´æŠ¤è¿æ¥çš„å•ä½ï¼ˆæˆ‘è¿™ä¸ªæè¿°æ„Ÿè§‰æœ‰ç‚¹å¥‡æ€ª ğŸ˜‚ ï¼‰ã€‚

### Session çŠ¶æ€

Zookeeper çš„æ‰€æœ‰æ“ä½œåŸºæœ¬éƒ½æ˜¯åŸºäº session çš„ï¼Œå¦‚ä¹‹å‰æåˆ°çš„ wathcer çš„æœºåˆ¶ï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„é¡ºåºæ‰§è¡Œå’Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸã€‚

ä»æˆ‘ä»¬ä½¿ç”¨ API çš„è§’åº¦ï¼Œsession çš„è¿æ¥å’Œä¿æŒå°±æ˜¯å®¢æˆ·ç«¯é€šè¿‡å®ä¾‹åŒ– Zookeeper å¯¹è±¡æ¥ä¸ Zookeeper server ç«¯åˆ›å»ºå¹¶ä¿æŒè¿æ¥ TCP è¿æ¥çš„è¿‡ç¨‹ã€‚åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªè¿æ¥åï¼Œä¸€ä¸ªä¼šè¯å°±è¢«åˆ›å»ºäº†ã€‚è€Œåœ¨ä¸€ä¸ªä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œsession çš„çŠ¶æ€å¯èƒ½åœ¨å‡ ç§ä¸åŒçš„çŠ¶æ€ä¸­åˆ‡æ¢ï¼Œè€Œè¿™äº›çŠ¶æ€å¯ä»¥åˆ†ä¸º connectingï¼Œconnectedï¼Œreconnectingï¼Œreconnectedï¼Œclose ç­‰ã€‚

#### çŠ¶æ€åˆ‡æ¢

1.  å®¢æˆ·ç«¯å°è¯•å»è¿æ¥æœåŠ¡å™¨ç«¯(public ZooKeeper(String connectString, int sessionTimeout, Watcher watcher) throws IOException)ï¼Œè¿™æ—¶å®¢æˆ·ç«¯å›å»å°è¯•è¿æ¥æœåŠ¡å™¨ï¼Œè€Œ session çš„çŠ¶æ€å°±å˜æˆäº† connectingã€‚è¿™ä¸ªè¿‡ç¨‹ä¹‹å‰åœ¨è®² sengthread çš„éƒ¨åˆ†æœ‰è¯¦ç»†è®²è¿‡ï¼Œå…·ä½“æ˜¯ client ä¼šä» serverï¼ˆHostProviderï¼‰çš„åˆ—è¡¨é‡Œé€ä¸ªå°è¯•è¿æ¥ï¼›
2.  ç”±äºç½‘ç»œæˆ–ç¨‹åºç­‰åŸå› å¯¼è‡´æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šå°è¯•å»é‡æ–°è¿æ¥ serverï¼Œåˆ™ session é‡æ–°è¿›å…¥ connecting çŠ¶æ€ï¼›
3.  é‡è¿æˆåŠŸåï¼Œsession å˜ä¸º connected çŠ¶æ€ï¼›
4.  ä¼šè¯è¶…æ—¶ï¼Œæƒé™æ£€æŸ¥å¤±è´¥æˆ–å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·æ–­å¼€è¿æ¥è¯·æ±‚å session å˜ä¸º close çŠ¶æ€ã€‚

p.s. è¿™é‡Œè¦æä¸€ä¸‹ç¬¬ä¸€æ­¥ï¼Œåœ¨ 3.2.0 ç‰ˆæœ¬ä¸­å¢åŠ äº† chroot åç¼€ï¼ˆé…ç½®æ—¶åŠ åœ¨åé¢ï¼Œä¸æ˜¯è¯´è¿™ä¸ª chroot çš„åŠŸèƒ½æ˜¯åç¼€ï¼Œè€Œä¸”æ°æ°ç›¸åï¼ŒåŠŸèƒ½æ˜¯å‰ç¼€ï¼‰çš„è®¾ç½®ï¼Œåœ¨ zk çš„é…ç½®ä¸­ç±»ä¼¼é…ç½® "127.0.0.1:4545/app/a" æˆ–è€… "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a"è¿™æ ·çš„è®¾ç½®ï¼Œé‚£ä¹ˆåœ¨ zookeeper ä¸Šæ‰€æœ‰çš„èŠ‚ç‚¹å‰éƒ½å›å®¶å†/app/a çš„å‰ç¼€ã€‚æ‰€ä»¥è¿æ¥ååœ¨ server ä¸Šçš„æ ¹èŠ‚ç‚¹æ˜¯/app/aã€‚

ä½œç”¨ï¼š`This feature is particularly useful in multi-tenant environments where each user of a particular ZooKeeper service could be rooted differently. This makes re-use much simpler as each user can code his/her application as if it were rooted at "/", while actual location (say /app/a) could be determined at deployment time.` Zookeeper å®˜æ–¹æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„ï¼Œå°±æ˜¯è¯´åœ¨ä¸€å°æœºå™¨æˆ– vm ä¸Šæœ‰å¤šä¸ª tenant å®‰è£… zookeeperï¼Œé€šè¿‡åœ¨é…ç½®ä¸­å¢åŠ è¿™æ ·çš„é…ç½®ï¼Œè¿™æ ·æ ¹æ®èŠ‚ç‚¹æœ¬èº«å°±çŸ¥é“å®ƒçš„å…·ä½“ä½ç½®ã€‚

Zookeeper å®˜æ–¹ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºçŠ¶æ€çš„å˜åŒ–ï¼š

![](img/e6f2d627afefdd498de326081e2eddb8.png)

ç»“åˆåœ¨ sendthread ä»‹ç»ä¸­è¯´çš„ï¼Œåœ¨ startconnect æ–¹æ³•ä¸­è¿æ¥ä¸­ä¼šæŠŠçŠ¶æ€è®¾ç½®ä¸º States.CONNECTINGï¼Œè¿æ¥æˆåŠŸå,åœ¨ Onconnected æ–¹æ³•é‡Œä¼šæŠŠçŠ¶æ€è®¾ç½®ä¸º CONNECTEDã€‚

åœ¨ zk çš„ create/exists/getchildrenâ€¦ç­‰ç­‰æ¥å£å†…éƒ¨æœ€åå›å» submitRequest å¹¶æŠŠç”Ÿæˆçš„ packet æ”¾å…¥ queue ä¸­ï¼Œåœ¨ queuePacket æ–¹æ³•çš„ cnLossPacket æ–¹æ³•ä¸­ä¼šæ ¹æ®çŠ¶æ€å»å¤„ç† session è¶…æ—¶ï¼ŒéªŒè¯å¤±è´¥å’Œè¿æ¥ä¸¢å¤±çš„é—®é¢˜ã€‚

```java
private void conLossPacket(Packet p) {
    if (p.replyHeader == null) {
        return;
    }
    switch (state) {
    case AUTH_FAILED://éªŒè¯å¤±è´¥
        p.replyHeader.setErr(KeeperException.Code.AUTHFAILED.intValue());
        break;
    case CLOSED://session è¶…æ—¶å¯¼è‡´ close
        p.replyHeader.setErr(KeeperException.Code.SESSIONEXPIRED.intValue());
        break;
    default://å…¶ä»–åŸå› å¯¼è‡´è¿æ¥ä¸¢å¤±
        p.replyHeader.setErr(KeeperException.Code.CONNECTIONLOSS.intValue());
    }
    finishPacket(p);
} 
```

åœ¨åˆ›å»º Session æ—¶ï¼Œéœ€è¦è®¾ç½® Session Timeout è¿™ä¸ªé‡è¦å‚æ•°ã€‚è¿™æ˜¯ Zookeeper æœåŠ¡å…è®¸ä¸€ä¸ª Session åœ¨å®šä¹‰å®ƒå¤±æ•ˆä¹‹å‰çš„æ—¶é—´ã€‚å¦‚æœæœåŠ¡åœ¨æ—¶é—´ t å†…ä¸èƒ½çœ‹åˆ°ä¸ä¸€ä¸ª Session å…³è”çš„æ¶ˆæ¯ï¼Œå®ƒå°†å®šä¹‰è¿™ä¸ª Session å¤±æ•ˆã€‚å¦‚æœå®¢æˆ·ç«¯åœ¨ 1/3 t æ—¶é—´å†…æ²¡æœ‰å¬åˆ°ä»»ä½•ä»æœåŠ¡å™¨è¿‡æ¥çš„æ¶ˆæ¯ï¼Œå®ƒå°†å‘é€ä¸€ä¸ªå¿ƒè·³æ¶ˆæ¯ç»™æœåŠ¡å™¨ã€‚åœ¨(2/3)t æ—¶é—´ï¼Œ Zookeeper å®¢æˆ·ç«¯å¼€å§‹å¯»æ‰¾å¦ä¸€ä¸ª Zookeeper æœåŠ¡å™¨ï¼Œå¹¶ä¸”å®ƒæœ‰å¦å¤–çš„(1/3)t çš„æ—¶é—´å¯»æ‰¾ã€‚

### ä¼šè¯åˆ›å»º

#### å®ä½“

```java
public interface SessionTracker {
public static interface Session {
    long getSessionId();ï¼Œ 
    int getTimeout();
    boolean isClosing();
}
public static interface SessionExpirer {
    void expire(Session session);

    long getServerId();
} 
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ SessionTracker æ¥å£ä¸­æœ‰ä¸¤ä¸ªå†…éƒ¨æ¥å£ Session å’Œ SessionExpirerï¼Œå¯ä»¥çœ‹åˆ°åˆ†åˆ«å’Œ session ä¸ session è¿‡æœŸæœ‰å…³ç³»ã€‚

```java
public static class SessionImpl implements Session {
    SessionImpl(long sessionId, int timeout, long expireTime) {
        this.sessionId = sessionId;
        this.timeout = timeout;
        this.tickTime = expireTime;
        isClosing = false;
    }

    final long sessionId;
    final int timeout;
    long tickTime;
    boolean isClosing;

    Object owner;

    public long getSessionId() { return sessionId; }
    public int getTimeout() { return timeout; }
    public boolean isClosing() { return isClosing; }
} 
```

åœ¨ SessionTrackerImpl ç±»ä¸­æœ‰ Session æ¥å£çš„å®ç°ç±»ï¼Œæ­¤ç±»ä¹Ÿä»£è¡¨äº†ä¸€ä¸ªçœŸæ­£çš„ session å¯¹è±¡ã€‚å¯ä»¥çœ‹åˆ° SessionImpl ç±»ä¸­æœ‰å‡ ä¸ªå˜é‡ï¼š

sessionIdï¼šä¼šè¯ IDï¼Œç”¨æ¥æ ‡è¯†ä¸€ä¸ªå”¯ä¸€ä¼šè¯ã€‚æ¯æ¬¡å®¢æˆ·ç«¯å’Œ server è¿æ¥åˆ›å»ºæ–°ä¼šè¯æ—¶ï¼Œzk ä¼šä¸ºå…¶åˆ†åˆ«ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼›

timeoutï¼šåœ¨åˆ›å»º zookeeper å¯¹è±¡æ—¶ä¼ å…¥çš„å‚æ•°ï¼Œå®¢æˆ·ç«¯å‘ server å‘é€äº†è¿™ä¸ªå‚æ•°åï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ® timeout æ—¶é—´æ¥åˆ¤æ–­ session çš„çŠ¶æ€ï¼›

ticktimeï¼šä¸‹æ¬¡ä¼šè¯è¶…æ—¶çš„æ—¶é—´ç‚¹ï¼Œå¤§çº¦ä¸ºå½“å‰æ—¶é—´+timeoutï¼Œå…·ä½“ä¹‹åè¯¦ç»†è§£é‡Šï¼›

isclosingï¼šè¡¨æ˜ä¸€ä¸ªä¼šè¯æ˜¯å¦å·²ç»è¢«å…³é—­ï¼Œå¦‚æœä¸€ä¸ªä¼šè¯å·²ç»è¢«æ ‡è®°ä¸º closingï¼Œserver ä¾¿ä¸ä¼šå¤„ç†æ¥è‡ªæ­¤ session çš„è¯·æ±‚ã€‚

#### SessionId ç”Ÿæˆç­–ç•¥

åœ¨ ZookeeperServer çš„ processConnectRequest æ–¹æ³•ä¸­æœ‰å¯¹å®¢æˆ·ç«¯å»ºç«‹è¿æ¥è¯·æ±‚çš„å¤„ç†ï¼š

```java
if (sessionId != 0) {//sessionId å·²ç»å­˜åœ¨
    long clientSessionId = connReq.getSessionId();
    LOG.info("Client attempting to renew session 0x"
            + Long.toHexString(clientSessionId)
            + " at " + cnxn.getRemoteSocketAddress());
    serverCnxnFactory.closeSession(sessionId);
    cnxn.setSessionId(sessionId);
    reopenSession(cnxn, sessionId, passwd, sessionTimeout);//é‡æ–°æ‰“å¼€ session
} else {
    LOG.info("Client attempting to establish new session at "
            + cnxn.getRemoteSocketAddress());
    createSession(cnxn, passwd, sessionTimeout);//æ–°å»º session
} 
```

```java
long createSession(ServerCnxn cnxn, byte passwd[], int timeout) {
    long sessionId = sessionTracker.createSession(timeout); 
```

```java
synchronized public long createSession(int sessionTimeout) {
    addSession(nextSessionId, sessionTimeout);
    return nextSessionId++;//æ¯æ¬¡å–è¿‡ä¹‹å nextSessionId+1
} 
```

```java
synchronized public void addSession(long id, int sessionTimeout) {
    sessionsWithTimeout.put(id, sessionTimeout);
    if (sessionsById.get(id) == null) {
        SessionImpl s = new SessionImpl(id, sessionTimeout, 0);//æ–°å»º sessionImpl å¯¹è±¡ 
```

å¯ä»¥çœ‹åˆ°åœ¨æ¯æ¬¡æ–°å»º session æ˜¯å»ºç«‹åœ¨å·²ç»ä¿å­˜çš„ nextSessionId çš„åŸºç¡€ä¸Šçš„ã€‚ç„¶åçœ‹ä¸€ä¸‹ nextSessionId çš„åˆå§‹åŒ–ï¼š

```java
public static long initializeNextSession(long id) {
    long nextSid = 0;
    nextSid = (Time.currentElapsedTime() << 24) >>> 8;
    nextSid =  nextSid | (id <<56);
    return nextSid;
} 
```

initializeNextSession æ–¹æ³•åœ¨ zookeeperserver å¯åŠ¨æ—¶çš„ startup æ–¹æ³•ä¸­ï¼Œstartup æ–¹æ³•ä¼šåˆå§‹åŒ– SessionTrackerImpl å˜é‡ï¼Œæ­¤æ—¶ nextSessionId ä¼šè¢«åˆå§‹åŒ–ã€‚

è¿™é‡Œç”¨åˆ°äº† Time.currentElapsedTime()æ–¹æ³•å»è·å¾—å½“å‰çš„æ—¶é—´ï¼Œæ˜¯ä¸€ä¸ª 64 ä½çš„å€¼ã€‚ä½†æ˜¯åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç”¨çš„æ˜¯ System.currentTimeMillis() æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆè¦ç”¨æ–°çš„æ–¹æ³•æ›¿ä»£åŸæ¥çš„å€¼ï¼Œäº‹å®ä¸Šåœ¨æ­£å¸¸æƒ…å†µä¸‹éƒ½ä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæœ‰äººä¿®æ”¹äº†ç³»ç»Ÿçš„æ—¶é—´ï¼Œé‚£ä¹ˆåŸæ¥çš„æ–¹æ³•å°±å¯èƒ½æœ‰é—®é¢˜ã€‚

è‡³äº nextSid ç”Ÿæˆçš„ç®—æ³•:ç³»ç»Ÿæ—¶é—´å…ˆå·¦ç§» 24 ä½ç„¶åæ— ç¬¦å·å³ç§» 8 ä½ç„¶åå’Œ myid æ–‡ä»¶ä¸­çš„å”¯ä¸€ id å€¼å·¦ç§» 56 ä½ç”Ÿæˆçš„å€¼åšæˆ–æ“ä½œï¼Œè¿™æ ·å¯ä»¥ç”Ÿäº§ä¸€ä¸ª 64 ä½çš„å”¯ä¸€ IDï¼Œç„¶ååé¢çš„ session åŸºäºè¿™ä¸ªå€¼é€’å¢è·å¾—ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ myid æ–‡ä»¶ä¸­é…ç½®å”¯ä¸€ id æ—¶å¿…é¡»è¦å°äº 256 çš„åŸå› ã€‚

### SessionTracker

sessiontracker çš„ä½œç”¨å°±æ˜¯ server ç”¨æ¥ç®¡ç†ä¼šè¯çš„ï¼Œå®ƒè´Ÿè´£äº† session çš„åˆ›å»ºï¼Œç®¡ç†å’Œåˆ é™¤ï¼Œæ•´ä¸ª session çš„ç”Ÿå‘½å‘¨æœŸéƒ½åœ¨ sessiontracker çš„ç®¡ç†ä¹‹ä¸‹ã€‚æ¯ä¸ª session åœ¨ sessiontracker å†…éƒ½åˆ†æˆä¸‰ä»½ä¿å­˜ã€‚

```java
public class SessionTrackerImpl extends ZooKeeperCriticalThread implements SessionTracker {
    private static final Logger LOG = LoggerFactory.getLogger(SessionTrackerImpl.class);

    HashMap<Long, SessionImpl> sessionsById = new HashMap<Long, SessionImpl>(); 

    HashMap<Long, SessionSet> sessionSets = new HashMap<Long, SessionSet>();//

    ConcurrentHashMap<Long, Integer> sessionsWithTimeout;
    long nextSessionId = 0;//ä¸‹ä¸€æ¬¡ session çš„ id
    long nextExpirationTime;//æœ€è¿‘çš„è¶…æ—¶æ—¶é—´

    int expirationInterval;//è¶…æ—¶æ£€æŸ¥é—´éš” 
```

```java
static class SessionSet {
    HashSet<SessionImpl> sessions = new HashSet<SessionImpl>();
} 
```

sessionsById æ˜¯æ ¹æ® session çš„ id æ¥ç®¡ç† session å®ä½“çš„å±æ€§ï¼›
sessionSets åˆ™æ˜¯æ ¹æ®ä¸‹æ¬¡è¶…æ—¶æ—¶é—´æ¥å½’æ¡£å›è¯ï¼Œä¾¿äºä¼šè¯ç®¡ç†å’Œè¶…æ—¶å®¡æŸ¥ï¼Œä¹Ÿå°±æ˜¯æŸä¸ªæ—¶é—´è¿‡æœŸçš„ä¼šè¯é›†åˆï¼›
sessionsWithTimeout æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒä¹Ÿæ˜¯æŒ‰ç…§ id æ¥ä¿å­˜ session çš„è¶…æ—¶æ—¶é—´é—´éš”ï¼ŒsessionsWithTimeout å’Œ zk çš„å†…å­˜æ•°æ®åº“ç›¸é€šï¼Œä¼šå®šæœŸåŒæ­¥åˆ°å¿«ç…§ä¸­ã€‚

### æ€è€ƒ

è¿™ä¸€ç¯‡ä¸»è¦è¯´äº†äº›å®è§‚çš„æ¦‚å¿µå’Œ session id çš„ç”Ÿæˆæœºåˆ¶ï¼Œæ¯”è¾ƒæ³›ï¼Œä½†æ˜¯æ˜¯ä¸‹ä¸€ç¯‡çš„åŸºç¡€ã€‚

### å‚è€ƒ

[https://zookeeper.apache.org/doc/r3.3.6/zookeeperProgrammers.html](https://zookeeper.apache.org/doc/r3.3.6/zookeeperProgrammers.html)

[https://blog.csdn.net/jeff_fangji/article/details/43916359](https://blog.csdn.net/jeff_fangji/article/details/43916359)

[https://www.jianshu.com/p/594129a44814](https://www.jianshu.com/p/594129a44814)

[http://www.cnblogs.com/leesf456/p/6103870.html](http://www.cnblogs.com/leesf456/p/6103870.html)

[https://xt00002003.iteye.com/blog/2302392](https://xt00002003.iteye.com/blog/2302392)